<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Holly Polly — Змейка</title>
<style>
  :root{ --page-bg:#FF007F; --field-bg:#E1CCFB; --control-green:#2e8b57; }
  html,body{height:100%;margin:0;}
  body{
    background:var(--page-bg);
    display:flex; flex-direction:column; align-items:center;
    font-family:"Futura","Trebuchet MS",Arial,sans-serif;
    padding:12px; box-sizing:border-box;
  }
  header{ text-align:center; margin-bottom:8px; }
  header img{ max-height:84px; display:block; margin:0 auto; }
  header .slogan{ color:#000; margin-top:8px; font-weight:700; }
  #container{ background:var(--field-bg); border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.25); position:relative; }
  canvas{ display:block; image-rendering: optimizeQuality; }
  .overlay-btn{
    position:absolute; left:50%; transform:translateX(-50%);
    background:var(--control-green); color:#fff; border:none;
    padding:12px 22px; border-radius:10px; font-size:18px;
    display:none; z-index:20; cursor:pointer;
  }
  #btnRestart{ top:42%; } #btnShare{ top:56%; }
  #controls{ margin-top:10px; display:grid;
    grid-template-areas: ". up ." "left . right" ". down ."; gap:8px; }
  .ctrl-btn{ width:64px; height:64px; border-radius:999px; background:var(--control-green);
    color:#fff; border:none; font-size:22px; cursor:pointer; }
  @media(max-width:480px){ .ctrl-btn{ width:54px; height:54px; font-size:18px; } }
  .lb-modal{ position:fixed; inset:0; background:rgba(0,0,0,.5);
    display:flex; align-items:center; justify-content:center; z-index:50; }
  .lb-modal[hidden]{ display:none; }
  .lb-card{ background:#fff; border-radius:14px; width:min(520px,92vw);
    box-shadow:0 10px 40px rgba(0,0,0,.35); padding:14px 16px; }
  .lb-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .lb-head h3{ margin:0; font-size:20px; }
  .lb-close{ background:#eee; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; }
  .lb-list{ margin:8px 0 0; padding:0 18px 12px; max-height:60vh; overflow:auto; }
  .lb-item-me{ background:#FFEBF7; border-radius:10px; padding:4px 8px; }
</style>
</head>
<body>
  <header>
    <img src="logo.png" alt="logo">
    <div class="slogan">Holly Polly — твоя лучшая подруга!</div>
  </header>

  <div id="container">
    <canvas id="game"></canvas>
    <button id="btnRestart" class="overlay-btn">Заново</button>
    <button id="btnShare" class="overlay-btn">Таблица лидеров</button>
  </div>

  <div id="leaderboardModal" class="lb-modal" hidden>
    <div class="lb-card">
      <div class="lb-head">
        <h3>Таблица лидеров</h3>
        <button id="lbClose" class="lb-close">✕</button>
      </div>
      <ol id="lbList" class="lb-list"></ol>
    </div>
  </div>

  <div id="controls">
    <div></div><button class="ctrl-btn" id="btnUp">↑</button><div></div>
    <button class="ctrl-btn" id="btnLeft">←</button><div></div><button class="ctrl-btn" id="btnRight">→</button>
    <div></div><button class="ctrl-btn" id="btnDown">↓</button><div></div>
  </div>

<script>
/* ===== CONFIG ===== */
const COLS = 12, ROWS = 22, BASE_STEP_MS = 120;
let stepDelay = Math.round(BASE_STEP_MS * 1.20);
const FOOD_SCALE = 2.42, MAX_OVERFLOW_PCT = 0.65, MAX_OVERFLOW_TILES = 0.9;
const HEARTS_BASE = 12, HEARTS_COUNT = Math.max(1, Math.round(HEARTS_BASE * 0.6));
const SPEED_MULT_BASE = 0.975, EXTRA_STEP_PCT = 0.003, SPEED_MULT_COMBINED = SPEED_MULT_BASE - EXTRA_STEP_PCT;
const MIN_STEP = 25, SMOOTH_LERP = 0.14;

/* ===== LeadTeh Webhook URL ===== */
const LEADTEH_WEBHOOK_URL = 'https://rb731135.leadteh.ru/inner_webhook/js/a515a26d-58ab-4b10-ac00-0be7f617530e';

/* ===== DOM ===== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const container = document.getElementById('container');
const btnRestart = document.getElementById('btnRestart');
const btnShare = document.getElementById('btnShare');

/* ===== Telegram WebApp init ===== */
function initTelegramWebApp() {
  try {
    if (window.Telegram?.WebApp) {
      Telegram.WebApp.ready?.();
    }
  } catch (e) {
    console.warn(e);
  }
}
initTelegramWebApp();
window.addEventListener('load', initTelegramWebApp);

/* helpers */
function getPlayerName(){
  let name = localStorage.getItem('hp_player_name');
  if (!name) { 
    name = (prompt('Как тебя подписать в таблице лидеров?') || 'Игрок').trim().slice(0, 40); 
    localStorage.setItem('hp_player_name', name); 
  }
  return name;
}
function getTelegramIdOrNull(){
  const u = window.Telegram?.WebApp?.initDataUnsafe?.user;
  return u?.id ? String(u.id) : '';
}

/* ===== Send data to LeadTeh ===== */
async function sendToLeadTeh(score) {
  const tgId = getTelegramIdOrNull();
  const username = getPlayerName();

  const data = {
    username: username,
    score: score,
    tg_id: tgId,
    contact_by: 'telegram', // Используем telegram для поиска контакта
    search: 'snake_game'
  };

  try {
    const response = await fetch(LEADTEH_WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
      },
      body: new URLSearchParams(data)
    });

    if (!response.ok) {
      console.error('Ошибка при отправке данных в LeadTeh:', response.status);
      return;
    }

    console.log('Данные успешно отправлены в LeadTeh!');
  } catch (error) {
    console.error('Ошибка запроса к LeadTeh:', error);
  }
}

/* ===== Game over logic ===== */
async function onGameOver() {
  const score = Number(scoreVar) || 0;
  console.log('GAME OVER, score=', score);
  
  // Отправляем данные в LeadTeh
  await sendToLeadTeh(score);
  
  btnRestart.style.display = 'block';
  btnShare.style.display = 'block';
}

/* ===== Step logic ===== */
function willCollide(nx,ny){ if(nx<0||ny<0||nx>=COLS||ny>=ROWS) return true; for(let i=1;i<snake.length;i++) if(snake[i].x===nx&&snake[i].y===ny) return true; return false; }
function performStep(){
  if (gameOver) return;
  const headGX=snake[0].x+dx, headGY=snake[0].y+dy;
  if (willCollide(headGX,headGY)){ gameOver=true; onGameOver(); return; }
  snake.unshift(createSegment(headGX,headGY));

  let ateExtra=false;
  if (extraFood){
    if (headGX>=extraFood.x && headGX<extraFood.x+extraFood.w && headGY>=extraFood.y && headGY<extraFood.y+extraFood.h){
      scoreVar+=extraFood.points; totalEaten++; eatenSinceSpeedup++; spawnParticlesAt(extraFood.x,extraFood.y,extraFood.w,extraFood.h,'hairspray'); extraFood=null; ateExtra=true;
    }
  }

  let ateMain=false;
  if (food && !ateExtra){
    if (headGX>=food.x && headGX<food.x+food.w && headGY>=food.y && headGY<food.y+food.h){
      ateMain=true; totalEaten++; eatenSinceSpeedup++; scoreVar+=food.points;
      spawnParticlesAt(food.x,food.y,food.w,food.h,food.cat);
      pendingHairspray=(Math.random()<0.10); placeFood();
    }
  }
  if(!ateMain && !ateExtra) snake.pop();

  if (eatenSinceSpeedup>=3){ stepDelay=Math.max(MIN_STEP,Math.round(stepDelay*SPEED_MULT_COMBINED)); eatenSinceSpeedup=0; }
  if (extraFood && performance.now()>extraFood.expiresAt) extraFood=null;
  scheduleNextStep();
}
function scheduleNextStep(){ if (timerId) clearTimeout(timerId); timerId=setTimeout(performStep, stepDelay); }

</script>
</body>
</html>


