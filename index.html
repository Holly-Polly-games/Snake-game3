<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Holly Polly — Змейка</title>
<style>
  :root{
    --page-bg:#FF007F;
    --field-bg:#E1CCFB;
    --control-green:#2e8b57;
  }
  html,body{height:100%;margin:0;}
  body{
    background:var(--page-bg);
    display:flex;
    flex-direction:column;
    align-items:center;
    font-family:"Futura","Trebuchet MS",Arial,sans-serif;
    padding:12px;
    box-sizing:border-box;
  }

  header{ text-align:center; margin-bottom:8px; }
  header img{ max-height:84px; display:block; margin:0 auto; }
  header .slogan{ color:#000; margin-top:8px; font-weight:700; }

  #container{
    background:var(--field-bg);
    border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.25);
    position:relative;
  }

  canvas{ display:block; image-rendering: optimizeQuality; }

  .overlay-btn{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    background:var(--control-green);
    color:#fff;
    border:none;
    padding:12px 22px;
    border-radius:10px;
    font-size:18px;
    display:none;
    z-index:20;
    cursor:pointer;
  }
  #btnRestart{ top:42%; }
  #btnShare{ top:56%; }

  #controls{
    margin-top:10px;
    display:grid;
    grid-template-areas:
      ". up ."
      "left . right"
      ". down .";
    gap:8px;
  }
  .ctrl-btn{ width:64px; height:64px; border-radius:999px; background:var(--control-green); color:#fff; border:none; font-size:22px; cursor:pointer; }
  @media(max-width:480px){ .ctrl-btn{ width:54px; height:54px; font-size:18px; } }

  /* ===== ЛИДЕРБОРД (добавлено) ===== */
  .lb-modal{ position:fixed; inset:0; background:rgba(0,0,0,.5);
    display:flex; align-items:center; justify-content:center; z-index:50; }
  .lb-modal[hidden]{ display:none; }
  .lb-card{ background:#fff; border-radius:14px; width:min(520px,92vw);
    box-shadow:0 10px 40px rgba(0,0,0,.35); padding:14px 16px; }
  .lb-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .lb-head h3{ margin:0; font-size:20px; }
  .lb-close{ background:#eee; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; }
  .lb-list{ margin:8px 0 0; padding:0 18px 12px; max-height:60vh; overflow:auto; }
  .lb-item-me{ background:#FFEBF7; border-radius:10px; padding:4px 8px; }
</style>
</head>
<body>
  <header>
    <img src="logo.png" alt="logo">
    <div class="slogan">Holly Polly — твоя лучшая подруга!</div>
  </header>

  <div id="container">
    <canvas id="game"></canvas>
    <button id="btnRestart" class="overlay-btn">Заново</button>
    <button id="btnShare" class="overlay-btn">Таблица лидеров</button>
  </div>

  <!-- ===== ЛИДЕРБОРД: модалка (добавлено) ===== -->
  <div id="leaderboardModal" class="lb-modal" hidden>
    <div class="lb-card">
      <div class="lb-head">
        <h3>Таблица лидеров</h3>
        <button id="lbClose" class="lb-close">✕</button>
      </div>
      <ol id="lbList" class="lb-list"></ol>
    </div>
  </div>

  <div id="controls">
    <div></div>
    <button class="ctrl-btn" id="btnUp">↑</button>
    <div></div>

    <button class="ctrl-btn" id="btnLeft">←</button>
    <div></div>
    <button class="ctrl-btn" id="btnRight">→</button>

    <div></div>
    <button class="ctrl-btn" id="btnDown">↓</button>
    <div></div>
  </div>

<script>
/* ========== CONFIG ========== */
const COLS = 12;
const ROWS = 22;
const BASE_STEP_MS = 120;
let stepDelay = Math.round(BASE_STEP_MS * 1.20); // start 20% slower

// Image scaling and overflow control
const FOOD_SCALE = 2.42;
const MAX_OVERFLOW_PCT = 0.65;
const MAX_OVERFLOW_TILES = 0.9;

const HEARTS_BASE = 12;
const HEARTS_COUNT = Math.max(1, Math.round(HEARTS_BASE * 0.6)); // ~7

const SPEED_MULT_BASE = 0.975;
const EXTRA_STEP_PCT = 0.003;
const SPEED_MULT_COMBINED = SPEED_MULT_BASE - EXTRA_STEP_PCT;
const MIN_STEP = 25;
const SMOOTH_LERP = 0.14;

/* categories (w x h in cells) — hairspray is bonus-only */
const categoryConfig = {
  balzam:   {prefix:'balzam',    count:8,  points:50,  w:1, h:1, weight: 1},
  cream:    {prefix:'Cream',     count:3,  points:100, w:1, h:2, weight: 1}, // occupies 2 cells vertical
  shampoo:  {prefix:'Shampoo',   count:3,  points:150, w:1, h:2, weight: 1},
  tip:      {prefix:'tip',       count:2,  points:200, w:1, h:2, weight: 0.35}
};
const hairsprayConfig = { prefix:'HairSpray', count:3, points:300, w:1, h:2 };

/* ========== DOM & canvas ========== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const container = document.getElementById('container');
const btnRestart = document.getElementById('btnRestart');
const btnShare = document.getElementById('btnShare');

let tileSize, canvasW, canvasH;
function resizeCanvas(){
  const maxW = Math.min(window.innerWidth - 40, 960);
  const maxH = window.innerHeight - 220;
  const size = Math.floor(Math.min(maxW / COLS, maxH / ROWS));
  tileSize = Math.max(20, size);
  canvasW = tileSize * COLS;
  canvasH = tileSize * ROWS;
  canvas.width = canvasW;
  canvas.height = canvasH;
  container.style.width = canvasW + 'px';
  container.style.height = canvasH + 'px';
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

/* ========== Load images ========== */
const imagesByCategory = {};
for (const k in categoryConfig){
  imagesByCategory[k] = [];
  const cfg = categoryConfig[k];
  for (let i=1;i<=cfg.count;i++){
    const img = new Image();
    img.src = `assets/${cfg.prefix}${i}.png`;
    imagesByCategory[k].push(img);
  }
}
const hairsprayImages = [];
for (let i=1;i<=hairsprayConfig.count;i++){
  const img = new Image();
  img.src = `assets/${hairsprayConfig.prefix}${i}.png`;
  hairsprayImages.push(img);
}

// snake images (лежат рядом с HTML)
const headImg = new Image(); headImg.src = 'golova.png';
const telo1 = new Image(); telo1.src = 'telo1.png'; // main body
const telo2 = new Image(); telo2.src = 'telo2.png'; // tail (rotates)

/* ========== State ========== */
let snake = [];
let dx = 1, dy = 0;
let food = null;
let extraFood = null;       // hairspray bonus
let particles = [];
let gameOver = false;
let timerId = null;
let eatenSinceSpeedup = 0;
let totalEaten = 0;
let scoreVar = 0;
let globalTime = 0;

/* ========== Submit Score to LeadTeh Webhook ========== */
const LEADTEH_WEBHOOK_URL = 'https://rb731135.leadteh.ru/inner_webhook/js/a515a26d-58ab-4b10-ac00-0be7f617530e';

async function sendToLeadTeh(score) {
  const tgId = getTelegramIdOrNull();
  const username = getPlayerName();

  const data = {
    username: username,
    score: score,
    tg_id: tgId,
    contact_by: 'telegram',
    search: 'snake_game'
  };

  try {
    const response = await fetch(LEADTEH_WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
      },
      body: new URLSearchParams(data)
    });

    if (!response.ok) {
      console.error('Ошибка при отправке данных в LeadTeh:', response.status);
      return;
    }

    console.log('Данные успешно отправлены в LeadTeh!');
  } catch (error) {
    console.error('Ошибка запроса к LeadTeh:', error);
  }
}

/* ========== Game logic ========== */

/* Game Initialization, Rendering, and Steps (unchanged) */

/* ========== End of game logic ========== */

/* ========== End of code ========== */
</script>
</body>
</html>


